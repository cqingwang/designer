<link rel="import" href="../wired-lib/wired-lib.html">

<dom-module id="wired-progress">
  <template>
    <style>
       :host {
        display: inline-block;
        position: relative;
        width: 400px;
        height: 42px;
        font-family: sans-serif;
      }

      svg {
        display: block;
      }

      path {
        stroke: currentColor;
        stroke-width: 0.7;
        fill: transparent;
      }

      .overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        pointer-events: none;
      }

      .labelContainer {
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .progressLabel {
        color: var(--wired-progress-label-color, #000);
        font-size: var(--wired-progress-font-size, 18px);
      }

      .progbox {
        fill: var(--wired-progress-color, rgba(0, 0, 200, 0.1));
        stroke-opacity: 0.6;
        stroke-width: 0.4;
      }
    </style>
    <div class="overlay">
      <svg id="svg"></svg>
    </div>
    <div class="overlay labelContainer">
      <div class="progressLabel">[[progressLabel]]</div>
    </div>
  </template>

  <script>
    class WiredProgress extends Polymer.Element {
      static get is() { return 'wired-progress'; }
      static get properties() {
        return {
          value: {
            type: Number,
            value: 0,
            observer: '_onProgress'
          },
          min: {
            type: Number,
            value: 0,
            observer: '_onProgress'
          },
          max: {
            type: Number,
            value: 100,
            observer: '_onProgress'
          },
          percentage: {
            type: Boolean,
            value: false,
            observer: '_updateLabel'
          },
          progressLabel: String
        };
      }

      connectedCallback() {
        super.connectedCallback();
        this._connected = true;
        this.style.opacity = 0;
        Polymer.RenderStatus.beforeNextRender(this, () => {
          this.relayout();
          this.style.opacity = 1;
        });
      }

      disconnectedCallback() {
        super.disconnectedCallback();
        this._connected = false;
      }

      _clearNode(node) {
        while (node.hasChildNodes()) {
          node.removeChild(node.lastChild);
        }
      }

      relayout() {
        if (!this._connected) {
          return;
        }
        this._clearNode(this.$.svg);
        var s = this.getBoundingClientRect();
        this.$.svg.setAttribute("width", s.width);
        this.$.svg.setAttribute("height", s.height);
        _WIRES_.rectangle(this.$.svg, 0, 0, s.width, s.height);

        let pct = 0;
        if (this.max > this.min) {
          pct = (this.value - this.min) / (this.max - this.min);
          const progWidth = s.width * Math.max(0, Math.min(pct, 100));
          const progBox = _WIRES_.polygon(this.$.svg, [
            [0, 0],
            [progWidth, 0],
            [progWidth, s.height],
            [0, s.height]
          ]);
          progBox.classList.add("progbox");
        }


        this._updateLabel();
      }

      _onProgress() {
        this.relayout();
      }

      _updateLabel() {
        if (this.percentage) {
          if (this.max == this.min) {
            this.set("progressLabel", "%");
          } else {
            var pct = Math.floor(((this.value - this.min) / (this.max - this.min)) * 100);
            this.set("progressLabel", pct + "%");
          }
        } else {
          this.set("progressLabel", "" + this.value);
        }
      }
    }

    window.customElements.define(WiredProgress.is, WiredProgress);
  </script>
</dom-module>